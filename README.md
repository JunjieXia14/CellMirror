# stClinic

*stClinic predicts clinically relevant tumor microenvironments from spatial omics data by dynamic graph learning.*

## Overview

![image](https://github.com/JunjieXia14/stClinic/blob/main/image/stClinic_logo.png)

stClinic is a tool for predicting clinically relevant tumor microenvironments from spatial omics data.

## Installation

Installation was tested on Ubuntu 22.10 with Python 3.8.17, Scanpy 1.9.3, PyTorch 1.12.0, and PyG (PyTorch Geometric) 2.3.0 on a machine with one 40-core Intel(R) Xeon(R) Silver 4210R CPU addressing with 128GB RAM, and one NVIDIA A800 GPU addressing 80GB. Please run stClinic on CUDA if possible.

### 1. Grab source code of stClinic

```bash
git clone https://github.com/JunjieXia14/stClinic.git
cd stClinic-main
```

### 2. Install stClinic in the virtual environment by conda

* Firstly, install conda: https://docs.anaconda.com/anaconda/install/index.html
* Then, automatically install all used packages (described by "environment.yml") for stClinic in a few mins.

```bash
conda config --set channel_priority strict
conda env create -f environment.yml
conda activate stClinic
```

Other software dependencies are listed in "requirements.txt".

## Quick start

### Unsupervised stClinic for integrating multiple slices

#### Input

We take the human dorsolateral prefrontal cortex (DLPFC) dataset of 10X Visium (four slices: 151673-151676) generated by Maynard et al. (*Nature Neuroscience*, 2021) as an example input, which includes three types of files: (1) gene expression data, (2) spatial location data, and (3) annotation labels for each spot. These input files are available at `Datasets/README.md`.

#### Run

Run the following commands in Linux Bash Shell:

```bash
cd Tutorials/code
python DLPFC_Unsupervised_Integration.py
```

This script automatically (1) loads the input data as an concatenated `AnnData` object, (2) constructs an unified graph based on spatial location and omics similarity, (3) learns batch-corrected features of four slices by stClinic in an unsupervised manner, (4) identifies spatial domains according to the joint embeddings by `mclust` algorithm, and (5) projects the latent features into 2D-UMAP space.

**Hyperparameters**

* R / rpy2 workpath: defines the work path of your R software and rpy2 package.
* used_device: defines the gpu index for training stClinic. The default value is 'cuda:0'.
* input_dir: defines the directory of input data files.
* path: defines the directory of output data files. The default value is './DLPFC'.
* rad_cutoff / k_cutoff: defines the radius value used in the construction of the intra-edges (according to spatial location data) for each slice. And the k_cutoff defines the number of spatial neighbors when using 'KNN' method for the construction of the intra-edges, with a default value of 6.
* n_top_genes: defines the number of highly variable genes to select for each slice. The default value is 5000, and this value can be larger than the default value for the large dataset with multiple slices (e.g., 18000 highly variable genes for CRCLM dataset).
* k: defines the number of nearest neighbors in other slices when using 'MNN' method for the construction of the inter-edges (based on omics similarity) for each slice. In the heterogeneous tissues like tumors, the value is set to 5, and in spatial multi-omics tissues, the value is set to 10, while in relatively homogeneous tissues, the value is 1 or 0.
* n_centroids: defines the number of components of GMM prior distribution.
* lr: defines learning rate parameter for learning batch-corrected embeddings of multiple slices by unsupervised stClinic. The default value of the parameter is 0.0005, and can be empirically set to the 1-20 folds (0.0005/20 - 0.0005) of this default value in different datasets.

#### Output

An concatenated `AnnData` object with stClinic embeddings and UMAP coordinates of four slices stored in `AnnData.obsm`, and spatial cluster labels stored in `AnnData.obs.mclust`.

Note: To reduce your waiting time, we have uploaded the processed `AnnData` object into `Datasets/DLPFC`.

### Supervised stClinic for predicting clinically relevant TMEs

#### Input

We take the human colorectal cancer and liver metastasis (CRCLM) dataset of 10X Visium (24 slices) generated by Villemin et al. (*Nucleic Acids Research*, 2023), Valdeolivas et al. (*npj Precision Oncology*, 2024), Wu et al. (*Cancer Discovery*, 2022), Garbarino et al. (*Aging Cell*, 2023), Wang et al. (*Science Advances*, 2023) as an example input for supervised mode of stClinic, which includes three types of files: (1) gene expression data, (2) spatial location data, and (3) sample labels. These input files are available at `Datasets/README.md`.

#### Run

We firstly run the following commands in Linux Bash Shell to (1) learn shared features of 24 CRCLM slices, (2) identifies spatial domains according to the joint embeddings by `Louvain` algorithm, and (3) project the latent features into 2D-UMAP space.

```bash
cd Tutorials/code
python CRCLM_Unsupervised_Integration.py
```

Note: To reduce your waiting time, we have uploaded the processed `AnnData` object into `Datasets/CRCLM`.

We then run the following command in Linux Bash Shell:

```bash
python CRCLM_Supervised_Prediction.py
```

This script automatically (1) computes 6 statistics measures of each cluster, (2) fuses them into slice representations by attention mechanism, (3) predicts condition-specific TMEs with the highest cluster contribution scores on different clinical states.

**Hyperparameters**

* pred_type: defines the prediction type of supervised stClinic model. In prognosis prediction task, the value is set to 'survival', which in classification task, the value is set to 'grading'.
* lr: defines learning rate parameter for predicting sample labels by supervised stClinic. The parameter is set to the value with the highest C-Index or classification accuracy in the grid search program of cross-validation.

#### Output

An concatenated `AnnData` object with stClinic embeddings and UMAP coordinates of 24 slices stored in `AnnData.obsm`, spatial cluster labels stored in `AnnData.obs.louvain`, and cluster contribution scores stored in `AnnData.uns`.

## More tutorials

Three more detailed tutorials and further visualization are introduced in the `Tutorials/notebook` folder to demonstrate how to implement stClinic:

* Tutorial 1: Integrating 4 DLPFC slices of homogeneous tissue.
* Tutorial 2: Integrating 2 breast cancer slices of heterogeneous tissues.
* Tutorial 3: Predicting metastasis-related TMEs from integrated colorectal cancer and liver metastasis slices.

## References

* stMVC: https://github.com/cmzuo11/stMVC
* STAligner: https://github.com/zhoux85/STAligner
* CellCharter: https://github.com/CSOgroup/cellcharter
* CytoCommunity: https://github.com/huBioinfo/CytoCommunity
* PathFinder: https://github.com/Biooptics2021/PathFinder

## Citation

* Xia J, Xu Y, Xu Y, Gao P, Zhang J, Wang Y, Zuo C*. stClinic predicts clinically relevant tumor microenvironments from spatial omics data by dynamic graph learning. 2024. (Submitted)
